# Android AOT + Partial IL Stripping Example

This project is an example of how one could AOT their Android project and IL strip _some_ of their DLLs. _Some_ because this process will only allow us to IL strip platform-independent code.

### Let's see this in action

1. Open up the solution (aotstriptest.sln) in Xamarin Studio
2. Ensure the configuration is correct. (This should already be configured but just in case):
    * Double click on the Android project
    * Select "Android Build" from the left panel
    * Change the configuration dropdown on the top to say "Release"
    * On the general tab make sure everything except for "Enable AOT (Experimental)" is selected. *You can enable LLVM but it is known to be unstable.*
    * On the advanced tab, select the ABI's you wish to support. Note that x86_64 is not currently supported.
    * Click ok
3. Build and deploy the project for Release

At this point you should see a very simple app in your emulator/device. Click the button on the screen and you should see the text change.

4. Go to your terminal and navigate to the project root.
5. Run the strip.sh script by doing

Essentially what it does is :
* Unzip the apk
* Strip the platform-independent assembly using mono-cil-strip
* Repackage the apk
* Uninstalls the old apk and reinstalls the new one.
* Launch the app.

At this point you can try and click on the button again and you can see that it is still working.


### What did we actually strip?

Lets look at the IL for the unstripped version.

    //Assuming you're at the root of the project
    $ monodis bin/Release/supersecretlib.dll > unstripped-lib.il

Looking inside unstripped-lib.il we see:
    
    .assembly extern System.Runtime
    {
      .ver 4:0:0:0
      .publickeytoken = (B0 3F 5F 7F 11 D5 0A 3A ) // .?_....:
    }
    .assembly extern System.Linq
    {
      .ver 4:0:0:0
      .publickeytoken = (B0 3F 5F 7F 11 D5 0A 3A ) // .?_....:
    }
    .assembly 'supersecretlib'
    {
      .custom instance void class [mscorlib]System.Reflection.AssemblyTitleAttribute::'.ctor'(string) =  (
    		01 00 0E 73 75 70 65 72 73 65 63 72 65 74 6C 69   // ...supersecretli
    		62 00 00                                        ) // b..
    
      .custom instance void class [mscorlib]System.Reflection.AssemblyDescriptionAttribute::'.ctor'(string) =  (01 00 00 00 00 ) // .....
    
      .custom instance void class [mscorlib]System.Reflection.AssemblyConfigurationAttribute::'.ctor'(string) =  (01 00 00 00 00 ) // .....
    
      .custom instance void class [mscorlib]System.Reflection.AssemblyCompanyAttribute::'.ctor'(string) =  (01 00 00 00 00 ) // .....
    
      .custom instance void class [mscorlib]System.Reflection.AssemblyProductAttribute::'.ctor'(string) =  (01 00 00 00 00 ) // .....
    
      .custom instance void class [mscorlib]System.Reflection.AssemblyCopyrightAttribute::'.ctor'(string) =  (01 00 05 77 61 73 69 68 00 00 ) // ...wasih..
    
      .custom instance void class [mscorlib]System.Reflection.AssemblyTrademarkAttribute::'.ctor'(string) =  (01 00 00 00 00 ) // .....
    
      .custom instance void class [mscorlib]System.Runtime.CompilerServices.RuntimeCompatibilityAttribute::'.ctor'() =  (
    		01 00 01 00 54 02 16 57 72 61 70 4E 6F 6E 45 78   // ....T..WrapNonEx
    		63 65 70 74 69 6F 6E 54 68 72 6F 77 73 01       ) // ceptionThrows.
    
      .hash algorithm 0x00008004
      .ver  1:0:6011:23681
    }
    .module supersecretlib.dll // GUID = {6FEF47B0-3FFE-4E7F-94B5-EAB1DA7A510C}
    
    
    .namespace supersecretlib
    {
      .class public auto ansi beforefieldinit MySuperSecretClass
      	extends [System.Runtime]System.Object
      {
        .field  private  string my_super_secret
        .field  private static  class [mscorlib]System.Func`2<string,int32> '<>f__am$cache0'
        .custom instance void class [mscorlib]System.Runtime.CompilerServices.CompilerGeneratedAttribute::'.ctor'() =  (01 00 00 00 ) // ....
    
    
        // method line 1
        .method public hidebysig specialname rtspecialname 
               instance default void '.ctor' ()  cil managed 
        {
            // Method begins at RVA 0x2050
    	// Code size 18 (0x12)
    	.maxstack 8
    	IL_0000:  ldarg.0 
    	IL_0001:  ldstr "mysupersecret"
    	IL_0006:  stfld string supersecretlib.MySuperSecretClass::my_super_secret
    	IL_000b:  ldarg.0 
    	IL_000c:  call instance void object::'.ctor'()
    	IL_0011:  ret 
        } // end of method MySuperSecretClass::.ctor
    
        // method line 2
        .method public hidebysig 
               instance default string getMySecret ()  cil managed 
        {
            // Method begins at RVA 0x2064
    	// Code size 113 (0x71)
    	.maxstack 4
    	.locals init (
    		string	V_0,
    		int32	V_1,
    		string[]	V_2)
    	IL_0000:  ldsfld string [System.Runtime]System.String::Empty
    	IL_0005:  stloc.0 
    	IL_0006:  ldc.i4.0 
    	IL_0007:  stloc.1 
    	IL_0008:  br IL_002c
    
    	IL_000d:  ldarg.0 
    	IL_000e:  ldfld string supersecretlib.MySuperSecretClass::my_super_secret
    	IL_0013:  callvirt instance char[] string::ToCharArray()
    	IL_0018:  call class [mscorlib]System.Collections.Generic.IEnumerable`1<!!0> class [System.Core]System.Linq.Enumerable::Reverse<char> (class [mscorlib]System.Collections.Generic.IEnumerable`1<!!0>)
    	IL_001d:  ldstr "woowwww magic"
    	IL_0022:  call string string::Concat(object, object)
    	IL_0027:  stloc.0 
    	IL_0028:  ldloc.1 
    	IL_0029:  ldc.i4.1 
    	IL_002a:  add 
    	IL_002b:  stloc.1 
    	IL_002c:  ldloc.1 
    	IL_002d:  ldc.i4.s 0x0a
    	IL_002f:  blt IL_000d
    
    	IL_0034:  ldc.i4.2 
    	IL_0035:  newarr [System.Runtime]System.String
    	IL_003a:  dup 
    	IL_003b:  ldc.i4.0 
    	IL_003c:  ldloc.0 
    	IL_003d:  stelem.ref 
    	IL_003e:  dup 
    	IL_003f:  ldc.i4.1 
    	IL_0040:  ldarg.0 
    	IL_0041:  ldfld string supersecretlib.MySuperSecretClass::my_super_secret
    	IL_0046:  stelem.ref 
    	IL_0047:  stloc.2 
    	IL_0048:  ldloc.2 
    	IL_0049:  ldsfld class [mscorlib]System.Func`2<string,int32> supersecretlib.MySuperSecretClass::'<>f__am$cache0'
    	IL_004e:  brtrue.s IL_0061
    
    	IL_0050:  ldnull 
    	IL_0051:  ldftn int32 class supersecretlib.MySuperSecretClass::'<getMySecret>m__0'(string)
    	IL_0057:  newobj instance void class [mscorlib]System.Func`2<string, int32>::'.ctor'(object, native int)
    	IL_005c:  stsfld class [mscorlib]System.Func`2<string,int32> supersecretlib.MySuperSecretClass::'<>f__am$cache0'
    	IL_0061:  ldsfld class [mscorlib]System.Func`2<string,int32> supersecretlib.MySuperSecretClass::'<>f__am$cache0'
    	IL_0066:  call class [System.Core]System.Linq.IOrderedEnumerable`1<!!0> class [System.Core]System.Linq.Enumerable::OrderBy<string, int32> (class [mscorlib]System.Collections.Generic.IEnumerable`1<!!0>, class [mscorlib]System.Func`2<!!0,!!1>)
    	IL_006b:  call !!0 class [System.Core]System.Linq.Enumerable::FirstOrDefault<string> (class [mscorlib]System.Collections.Generic.IEnumerable`1<!!0>)
    	IL_0070:  ret 
        } // end of method MySuperSecretClass::getMySecret
    
        // method line 3
        .method private static hidebysig 
               default int32 '<getMySecret>m__0' (string c)  cil managed 
        {
            .custom instance void class [mscorlib]System.Runtime.CompilerServices.CompilerGeneratedAttribute::'.ctor'() =  (01 00 00 00 ) // ....
    
            // Method begins at RVA 0x20e1
    	// Code size 7 (0x7)
    	.maxstack 8
    	IL_0000:  ldarg.0 
    	IL_0001:  callvirt instance int32 string::get_Length()
    	IL_0006:  ret 
        } // end of method MySuperSecretClass::<getMySecret>m__0
    
      } // end of class supersecretlib.MySuperSecretClass
    }

Ok now let's disassemble the stripped version:

    $ monodis bin/Release/stripped/assemblies/supersecretlib.dll > stripped-lib.il
    
Looking inside we see only references to class names and members remain.

      .assembly extern mscorlib
      {
        .ver 4:0:0:0
        .publickeytoken = (B7 7A 5C 56 19 34 E0 89 ) // .z\V.4..
      }
      .assembly extern mscorlib
      {
        .ver 2:0:5:0
        .publickeytoken = (7C EC 85 D7 BE A7 79 8E ) // |.....y.
      }
      .assembly extern System.Core
      {
        .ver 2:0:5:0
        .publickeytoken = (7C EC 85 D7 BE A7 79 8E ) // |.....y.
      }
      .assembly 'supersecretlib'
      {
        .custom instance void class [mscorlib]System.Reflection.AssemblyConfigurationAttribute::'.ctor'(string) =  (01 00 00 00 00 ) // .....
    
        .custom instance void class [mscorlib]System.Reflection.AssemblyTrademarkAttribute::'.ctor'(string) =  (01 00 00 00 00 ) // .....
    
        .custom instance void class [mscorlib]System.Reflection.AssemblyCopyrightAttribute::'.ctor'(string) =  (01 00 05 77 61 73 69 68 00 00 ) // ...wasih..
    
        .custom instance void class [mscorlib]System.Reflection.AssemblyProductAttribute::'.ctor'(string) =  (01 00 00 00 00 ) // .....
    
        .custom instance void class [mscorlib]System.Reflection.AssemblyCompanyAttribute::'.ctor'(string) =  (01 00 00 00 00 ) // .....
    
        .custom instance void class [mscorlib]System.Runtime.CompilerServices.RuntimeCompatibilityAttribute::'.ctor'() =  (
      		01 00 01 00 54 02 16 57 72 61 70 4E 6F 6E 45 78   // ....T..WrapNonEx
      		63 65 70 74 69 6F 6E 54 68 72 6F 77 73 01       ) // ceptionThrows.
    
        .custom instance void class [mscorlib]System.Reflection.AssemblyDescriptionAttribute::'.ctor'(string) =  (01 00 00 00 00 ) // .....
    
        .custom instance void class [mscorlib]System.Reflection.AssemblyTitleAttribute::'.ctor'(string) =  (
      		01 00 0E 73 75 70 65 72 73 65 63 72 65 74 6C 69   // ...supersecretli
      		62 00 00                                        ) // b..
    
        .hash algorithm 0x00008004
        .ver  1:0:6011:22654
      }
      .module supersecretlib.dll // GUID = {78B32159-BC1D-48BE-959D-0241F11976C1}
    
    
      .namespace supersecretlib
      {
        .class public auto ansi beforefieldinit MySuperSecretClass
        	extends [mscorlib]System.Object
        {
          .field  private  string my_super_secret
          .field  private static  class [mscorlib]System.Func`2<string,int32> '<>f__am$cache0'
          .custom instance void class [mscorlib]System.Runtime.CompilerServices.CompilerGeneratedAttribute::'.ctor'() =  (01 00 00 00 ) // ....
    
    
          // method line 1
          .method public hidebysig specialname rtspecialname 
                 instance default void '.ctor' ()  cil managed 
          {
              // Method begins at RVA 0x2050
      	// Code size 1 (0x1)
      	.maxstack 8
      	IL_0000:  ret 
          } // end of method MySuperSecretClass::.ctor
    
          // method line 2
          .method public hidebysig 
                 instance default string getMySecret ()  cil managed 
          {
              // Method begins at RVA 0x2050
      	// Code size 1 (0x1)
      	.maxstack 8
      	IL_0000:  ret 
          } // end of method MySuperSecretClass::getMySecret
    
          // method line 3
          .method private static hidebysig 
                 default int32 '<getMySecret>m__0' (string c)  cil managed 
          {
              .custom instance void class [mscorlib]System.Runtime.CompilerServices.CompilerGeneratedAttribute::'.ctor'() =  (01 00 00 00 ) // ....
    
              // Method begins at RVA 0x2050
      	// Code size 1 (0x1)
      	.maxstack 8
      	IL_0000:  ret 
          } // end of method MySuperSecretClass::<getMySecret>m__0
    
        } // end of class supersecretlib.MySuperSecretClass
      }






